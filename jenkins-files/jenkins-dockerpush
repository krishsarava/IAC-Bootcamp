pipeline {
     agent { label  'java'}
      environment {
     REPO_DIR = "${WORKSPACE}"
     gitlab=credentials('gitlab_connectivity')
     IMAGE_NAME = "krishsarava/python_app"
     DOCKER_CREDENTIALS = credentials('docker_cred')
     BUILD_NUMBER = new Date().format("yyyyMMdd")
    }
    stages {
        stage('Checkout Repository') {
            steps {
                // Checkout the repository containing both Terraform and Ansible files
                 git credentialsId: 'gitlab_connectivity', branch: 'H1', url: 'https://gitlab.stackroute.in/nw-jan-25/h1-sk-repo.git'
            }
        }
        stage('dockerbuild') {
            steps {
                // Checkout the repository containing both Terraform and Ansible files
                 sh """cd ${REPO_DIR}/python_docker && sudo docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} ."""
            }
        }
        stage('Login to Docker Registry') {
            steps {
                script {
                    // Log in to Docker Hub or a private Docker registry
                    sh 'echo ${DOCKER_CREDENTIALS_PSW} | sudo docker login -u ${DOCKER_CREDENTIALS_USR} --password-stdin'
                }
            }
        }
        stage('Push Docker Image') {
            steps {
                script {
                    // Push the Docker image to the Docker registry
                    sh """sudo docker push ${IMAGE_NAME}:${BUILD_NUMBER} """
                }
            }
        }
    }
}